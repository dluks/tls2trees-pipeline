# TLS-to-trees processing pipeline

This repository contains a bash script (`tls2trees.sh`) that implements a processing pipeline for converting terrestrial laser scanning (TLS) data to tree models. The pipeline consists of the following steps:

1. Convert LAS files to PLY files using `las2ply.py`
2. Downsample PLY files using `downsample.py`
3. Create a tile index for the downsampled PLY files using `tile_index.py`
4. Classify the downsampled PLY files using `fsct/run.py`
5. Perform instance segmentation on the classified PLY files using `instance_seg_tile` (which in turn uses `points2trees.py`)
6. Generate QSMs, select optimal QSMs, and calculate biomass using `TreeQSM`.

The full pipeline can be run with
```bash
bash tls2trees.sh
```

Running individual steps currently requires manual commenting out of the steps that you don't want to run. An update to include desired steps as arguments to the bash script is in progress.

## Requirements

The bulk of the requirements can be found in the [`rxp-pipeline`](https://github.com/dluks/rxp-pipeline) and [`TLS2trees`](https://github.com/dluks/TLS2trees) respositories.

In order to run `ply2txt.sh` you will need to install [PDAL](https://pdal.io/en/latest/).

## Setup

### Clone or fork the relevant projects

In your project directory, clone [`rxp-pipeline`](https://github.com/dluks/rxp-pipeline), [`TLS2trees`](https://github.com/dluks/TLS2trees), and [`TreeQSM`](https://github.com/dluks/TreeQSM)
```
> git clone git@github.com:dluks/rxp-pipeline.git
> git clone git@github.com:dluks/TLS2trees.git
> git clone git@github.com:dluks/TreeQSM.git
```

Before you can use the TLS2trees package, you first need to install it as a local, editable module:

```
> cd TLS2Trees
> pip install -e .
```

## Usage

To use the pipeline, follow these steps:

1. Clone this repository to your local machine.
2. Install the required software packages (see above).
3. Modify the default values for the pipeline variables in `tls2trees.sh` as needed.
4. Run the pipeline using the `tls2trees.sh` script.

Because the QSM generation requires MATLAB, it can't be run from a bash script. For that you'll make use of `TreeQSM/src/run_qsm.m` and `TreeQSM/src/calculate_biomass.m`.

## Pipeline Steps

### 1. LAS2PLY

Converts LAS files to PLY files using `rxp-pipeline/las2ply.py`.

### 2. DOWNSAMPLE

Downsamples PLY files using `rxp-pipeline/downsample.py`.

### 3. TILE INDEX

Creates a tile index for the downsampled PLY files using `rxp-pipeline/tile_index.py`.

### 4. FSCT CLASSIFICATION

Classifies the downsampled PLY files using `TLS2trees/tls2trees/semantic.py`.

### 5. INSTANCE SEGMENTATION

Performs instance segmentation on the classified PLY files using `instance_seg_tile` (which in turn calls `TLS2trees/tls2trees/instance.py`)

### 6. QSM GENERATION

1. Convert your extracted trees into `.csv` files using `ply2txt.sh`
2. Generate the un-optimized and optimized QSMs using `TreeQSM/src/run_qsm.m`.
2. Calculate biomass of the resulting tree models using `TreeQSM/src/calculate_biomass.m`

## Pipeline Variables

The following variables in `tls2trees.sh` can be modified to customize the pipeline:

- `PROJ_DIR`: The project directory.
- `LAS_DIR`: The directory containing the LAS files.
- `T2T_DIR`: The directory containing the `tls2trees.sh` script.
- `EXT`: The directory containing the extraction scripts.
- `LAS2PLY_DIR`: The directory to store the PLY files generated by `las2ply.py`.
- `DOWNSMP_DIR`: The directory to store the downsampled PLY files generated by `downsample.py`.
- `TILE_INDEX`: The file path to store the tile index generated by `tile_index.py`.
- `FSCT_DIR`: The directory to store the classified PLY files generated by `fsct/run.py`.
- `CLOUD_DIR`: The directory to store the segmented point clouds generated by `instance_seg_tile`.
- `NUM_PROCS`: The number of processes to use for multiprocessing.
- `USE_MULTIPROCESSING`: Whether to use multiprocessing for the instance segmentation step.
- `FILES`: The input directory for the current pipeline step.
- `ODIR`: The output directory for the current pipeline step.
- Other variables specific to each pipeline step.

## License

This code is licensed under the MIT License. See the `LICENSE` file for details.